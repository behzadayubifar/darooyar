# NATS Integration for Darooyar Server

این بخش از کد سرور دارویار برای ادغام با NATS طراحی شده است. NATS یک سیستم پیام‌رسانی سبک و با کارایی بالاست که برای ارتباطات بین سرویس‌ها و مدیریت درخواست‌های زمان‌بر مانند درخواست‌های API به هوش مصنوعی استفاده می‌شود.

## مزایای استفاده از NATS

1. **پردازش غیرهمزمان**: درخواست‌های زمان‌بر به هوش مصنوعی به صورت غیرهمزمان پردازش می‌شوند، بنابراین سرور می‌تواند به درخواست‌های دیگر پاسخ دهد.
2. **مقیاس‌پذیری**: می‌توانید چندین نمونه از سرور را اجرا کنید که همگی به یک سرور NATS متصل می‌شوند.
3. **قابلیت اطمینان**: NATS دارای مکانیزم‌های بازیابی خطا و تلاش مجدد است که باعث افزایش قابلیت اطمینان سیستم می‌شود.
4. **توزیع بار**: درخواست‌ها می‌توانند بین چندین پردازنده توزیع شوند.

## نصب و راه‌اندازی NATS

### نصب NATS Server

#### با استفاده از Docker

```bash
docker run -d --name nats-server -p 4222:4222 -p 8222:8222 -p 6222:6222 nats
```

#### نصب مستقیم

برای نصب مستقیم NATS Server، به [مستندات رسمی NATS](https://docs.nats.io/running-a-nats-service/introduction/installation) مراجعه کنید.

### پیکربندی

آدرس سرور NATS را در فایل `.env` تنظیم کنید:

```
NATS_URL=nats://localhost:4222
```

## نحوه کارکرد

1. درخواست‌های API به هوش مصنوعی از طریق NATS ارسال می‌شوند.
2. سرویس AI که به NATS متصل است، درخواست‌ها را دریافت و پردازش می‌کند.
3. پاسخ‌ها از طریق NATS به سرور برگردانده می‌شوند.

## موضوعات (Subjects) NATS

- `ai.completion`: برای درخواست‌های تکمیل متن
- `ai.completion.response`: برای پاسخ‌های تکمیل متن
- `ai.prescription`: برای درخواست‌های تحلیل نسخه
- `ai.prescription.response`: برای پاسخ‌های تحلیل نسخه

## عیب‌یابی

اگر با خطای اتصال به NATS مواجه شدید:

1. بررسی کنید که سرور NATS در حال اجرا باشد.
2. بررسی کنید که آدرس NATS در فایل `.env` صحیح باشد.
3. بررسی کنید که پورت 4222 در فایروال باز باشد.

سرور دارویار در صورت عدم دسترسی به NATS، به صورت خودکار به حالت پردازش مستقیم (بدون NATS) برمی‌گردد.
